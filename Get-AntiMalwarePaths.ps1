<#
.Synopsis
   Give a table of Antimalware Exclusions
.DESCRIPTION
   Exports all Antimalware Paths that have been configured on Azure Virtual Machines
.EXAMPLE
   Get-AntiMalwarePaths -ResourceGroup 'UfsAuRG-A'
.EXAMPLE
   Another example of how to use this cmdlet
#>
function Get-AntiMalwarePaths
{
    [CmdletBinding()]
    Param
    (
        # An Azure Resource Group
        [Parameter(Mandatory=$true)]
        [string]$ResourceGroup,
        [Parameter(Mandatory=$false)]
        [string]$ExportPath,
        [Parameter(Mandatory=$false)]
        [switch]$ShowTable=$false,
        [Parameter(Mandatory=$false)]
        [switch]$Details=$false
    )

    Begin
    {
        $MasterList = @()
        if ($Details) {
            Write-host "Enumerating list of virtual machines from $ResourceGroup" -ForegroundColor Yellow
        }
        $VMList = Get-AzVM -ResourceGroupName $ResourceGroup
    }
    Process
    {
        foreach ($VM in $VMList) {
            $Settings = $null
            $Antimalware = Get-AzVMExtension -ResourceGroupName $VM.Resourcegroupname -VMName $VM.Name -Name 'IaaSAntimalware' -ErrorAction SilentlyContinue
            If ($Antimalware -eq $null) {
                If ($Details) {
                    Write-Host $VM.Name"has no Antimalware configured" -ForegroundColor Red
                }
                $VMObj = New-Object -TypeName PSObject
                $VMObj | Add-Member -MemberType Noteproperty -Name "VMName" -Value $VM.Name
                $VMObj | Add-Member -MemberType Noteproperty -Name "ExclusionPath" -Value 'None Found'
                $MasterList += $VMObj
            }
            else {
                If ($Details) {
                    Write-Host "Enumerating exclusions for"$VM.Name -ForegroundColor Yellow
                }
                $Settings = $Antimalware.PublicSettings | ConvertFrom-Json
                $Paths = $Settings.Exclusions.Paths.Split(';')
                $ExList = @()
                foreach ($Path in $Paths) {
                    $VMObj = New-Object -TypeName PSObject
                    $VMObj | Add-Member -MemberType Noteproperty -Name "VMName" -Value $VM.Name
                    $VMObj | Add-Member -MemberType Noteproperty -Name "ExclusionPath" -Value $Path
                    $ExList += $VMObj
                If ($Details) {
                    $VMObj
                }
                }
                $MasterList += $ExList
            }
        }
    }
    End
    {
        if ($ShowTable) {
        $MasterList | Format-Table
        }
        if ($ExportPath) {
        $MasterList | Convertto-Csv | Out-file $ExportPath
        }
        
    }
}

Get-AntiMalwarePaths -ResourceGroup 'UfsAuRG-B' -Details